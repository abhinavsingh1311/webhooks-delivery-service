<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Documentation - Webhook Delivery Service</title>
    <link rel="stylesheet" href="api.css" />
    <link rel="icon" type="image/x-icon" href="favicon.png" />
</head>
<body>

    <header>
        <h1>API DOCUMENTATION</h1>
        <p>Webhook Delivery Service - REST API Reference</p>
    </header>

    <nav>
        [<a href="index.html">Home</a>]
        [<a href="#authentication">Auth</a>]
        [<a href="#endpoints">Endpoints</a>]
        [<a href="#events">Events</a>]
        [<a href="#errors">Errors</a>]
        [<a href="#signatures">Signatures</a>]
        [<a href="https://github.com/abhinavsingh1311/webhooks-delivery-service">GitHub</a>]
    </nav>

    <div class="toc">
        <h3>Table of Contents</h3>
        <ul>
            <li><a href="#authentication">Authentication</a></li>
            <li><a href="#base-url">Base URL</a></li>
            <li>
                <a href="#endpoints">Endpoints API</a>
                <ul>
                    <li><a href="#post-endpoints">POST /api/endpoints</a></li>
                    <li><a href="#patch-toggle">PATCH /api/endpoints/{id}/toggle</a></li>
                </ul>
            </li>
            <li>
                <a href="#events">Events API</a>
                <ul>
                    <li><a href="#post-events">POST /api/events</a></li>
                    <li><a href="#get-status">GET /api/events/{id}/status</a></li>
                    <li><a href="#get-deadletter">GET /api/deadletter</a></li>
                </ul>
            </li>
            <li><a href="#errors">Error Codes</a></li>
            <li><a href="#signatures">Signature Verification</a></li>
        </ul>
    </div>

    <section id="authentication">
        <h2>Authentication</h2>

        <p>
            Most endpoints require an API key. Include it in the <code>X-API-Key</code> header:
        </p>

<pre>
GET /api/events/1/status HTTP/1.1
Host: localhost:7068
X-API-Key: your-api-key-here
</pre>

        <h3>Getting an API Key</h3>
        <p>
            Register a webhook endpoint via <code>POST /api/endpoints</code>.
            This is the only public endpoint — no authentication required.
            The API key is returned in the response. <strong>Save it!</strong>
        </p>

        <h3>Authentication Flow</h3>
<pre>
Request arrives
    |
    v
Is path /api/* ?
    |
   NO --> Allow (UI pages)
    |
   YES
    |
    v
Is POST /api/endpoints ?
    |
   YES --> Allow (public registration)
    |
   NO
    |
    v
Has X-API-Key header?
    |
   NO --> 401 Unauthorized
    |
   YES
    |
    v
Is key valid in database?
    |
   NO --> 401 Unauthorized
    |
   YES --> Process request
</pre>
    </section>

    <section id="base-url">
        <h2>Base URL</h2>
<pre>
Local:  https://localhost:7068
Prefix: /api
</pre>
    </section>

    <hr>

    <section id="endpoints">
        <h2>Endpoints API</h2>

        <div class="endpoint" id="post-endpoints">
            <div class="endpoint-header">
                <span class="method post">POST</span>
                <code>/api/endpoints</code>
                <span class="tag yellow">Public - No Auth</span>
            </div>
            <div class="endpoint-body">
                <p><strong>Register a new webhook endpoint.</strong></p>
                <p>Creates endpoint and returns API key for future requests.</p>

                <h4>Request Headers</h4>
                <table>
                    <tr><th>Header</th><th>Value</th></tr>
                    <tr><td>Content-Type</td><td>application/json</td></tr>
                </table>

                <h4>Request Body</h4>
                <table>
                    <tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr>
                    <tr>
                        <td><code>name</code></td>
                        <td>string</td>
                        <td class="required">Yes</td>
                        <td>Friendly name for the endpoint</td>
                    </tr>
                    <tr>
                        <td><code>url</code></td>
                        <td>string</td>
                        <td class="required">Yes</td>
                        <td>URL where webhooks will be delivered</td>
                    </tr>
                    <tr>
                        <td><code>secret</code></td>
                        <td>string</td>
                        <td class="required">Yes</td>
                        <td>Secret for HMAC signature generation</td>
                    </tr>
                </table>

                <h4>Example Request</h4>
<pre>
POST /api/endpoints HTTP/1.1
Content-Type: application/json

{
  "name": "My Webhook",
  "url": "https://webhook.site/abc123",
  "secret": "my-secret-key-123"
}
</pre>

                <h4>Example Response (201 Created)</h4>
<pre>
{
  "id": 1,
  "name": "My Webhook",
  "url": "https://webhook.site/abc123",
  "isActive": true,
  "createdAt": "2025-01-01T00:00:00Z",
  "apiKey": "a1b2c3d4e5f6..."
}
</pre>
                <p><strong>Important:</strong> Save the <code>apiKey</code> — it won't be shown again!</p>
            </div>
        </div>

        <div class="endpoint" id="patch-toggle">
            <div class="endpoint-header">
                <span class="method patch">PATCH</span>
                <code>/api/endpoints/{id}/toggle</code>
                <span class="tag red">Auth Required</span>
            </div>
            <div class="endpoint-body">
                <p><strong>Toggle endpoint active status.</strong></p>
                <p>Disabled endpoints won't receive webhook deliveries.</p>

                <h4>Path Parameters</h4>
                <table>
                    <tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
                    <tr><td><code>id</code></td><td>integer</td><td>Endpoint ID</td></tr>
                </table>

                <h4>Example Response (200 OK)</h4>
<pre>
{
  "id": 1,
  "isActive": false
}
</pre>
            </div>
        </div>
    </section>

    <hr>

    <section id="events">
        <h2>Events API</h2>

        <div class="endpoint" id="post-events">
            <div class="endpoint-header">
                <span class="method post">POST</span>
                <code>/api/events</code>
                <span class="tag red">Auth Required</span>
            </div>
            <div class="endpoint-body">
                <p><strong>Send a webhook event.</strong></p>
                <p>Event is persisted immediately and processed by background worker.</p>

                <h4>Request Headers</h4>
                <table>
                    <tr><th>Header</th><th>Value</th></tr>
                    <tr><td>Content-Type</td><td>application/json</td></tr>
                    <tr><td>X-API-Key</td><td>your-api-key</td></tr>
                </table>

                <h4>Request Body</h4>
                <table>
                    <tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr>
                    <tr>
                        <td><code>eventPointId</code></td>
                        <td>integer</td>
                        <td class="required">Yes</td>
                        <td>Target endpoint ID</td>
                    </tr>
                    <tr>
                        <td><code>eventType</code></td>
                        <td>string</td>
                        <td class="required">Yes</td>
                        <td>Event type (e.g., "order.created")</td>
                    </tr>
                    <tr>
                        <td><code>payload</code></td>
                        <td>string</td>
                        <td class="required">Yes</td>
                        <td>JSON payload to deliver</td>
                    </tr>
                </table>

                <h4>Example Request</h4>
<pre>
POST /api/events HTTP/1.1
Content-Type: application/json
X-API-Key: a1b2c3d4e5f6...

{
  "eventPointId": 1,
  "eventType": "order.created",
  "payload": "{\"orderId\": 123, \"amount\": 99.99}"
}
</pre>

                <h4>Example Response (201 Created)</h4>
<pre>
{
  "eventId": 5,
  "endpointId": 1,
  "eventType": "order.created",
  "status": "Pending"
}
</pre>
            </div>
        </div>

        <div class="endpoint" id="get-status">
            <div class="endpoint-header">
                <span class="method get">GET</span>
                <code>/api/events/{id}/status</code>
                <span class="tag red">Auth Required</span>
            </div>
            <div class="endpoint-body">
                <p><strong>Check delivery status of an event.</strong></p>

                <h4>Path Parameters</h4>
                <table>
                    <tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
                    <tr><td><code>id</code></td><td>integer</td><td>Event ID</td></tr>
                </table>

                <h4>Example Response (200 OK)</h4>
<pre>
{
  "id": 5,
  "status": "Delivered",
  "attemptCount": 1,
  "lastResponsecode": 200,
  "lastAttemptAt": "2025-01-01T00:00:05Z",
  "deliveredAt": "2025-01-01T00:00:05Z",
  "lastErrorMessage": null
}
</pre>

                <h4>Status Values</h4>
                <table>
                    <tr><th>Status</th><th>Description</th></tr>
                    <tr>
                        <td><span class="tag yellow">Pending</span></td>
                        <td>Queued for delivery or awaiting retry</td>
                    </tr>
                    <tr>
                        <td><span class="tag green">Delivered</span></td>
                        <td>Successfully delivered (2xx response)</td>
                    </tr>
                    <tr>
                        <td><span class="tag red">Failed</span></td>
                        <td>Endpoint not found or inactive</td>
                    </tr>
                    <tr>
                        <td><span class="tag">DeadLetter</span></td>
                        <td>Max retries (6) exceeded</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="endpoint" id="get-deadletter">
            <div class="endpoint-header">
                <span class="method get">GET</span>
                <code>/api/deadletter</code>
                <span class="tag red">Auth Required</span>
            </div>
            <div class="endpoint-body">
                <p><strong>View dead letter queue.</strong></p>
                <p>Returns events that failed after maximum retry attempts.</p>

                <h4>Example Response (200 OK)</h4>
<pre>
[
  {
    "id": 3,
    "eventType": "payment.failed",
    "status": "DeadLetter",
    "attemptCount": 6,
    "lastResponsecode": 503,
    "lastErrorMessage": "Service Unavailable"
  }
]
</pre>
            </div>
        </div>
    </section>

    <hr>

    <section id="errors">
        <h2>Error Codes</h2>

        <table>
            <tr><th>Code</th><th>Status</th><th>Description</th></tr>
            <tr><td>200</td><td>OK</td><td>Request successful</td></tr>
            <tr><td>201</td><td>Created</td><td>Resource created</td></tr>
            <tr><td>400</td><td>Bad Request</td><td>Invalid request body</td></tr>
            <tr><td>401</td><td>Unauthorized</td><td>Missing or invalid API key</td></tr>
            <tr><td>404</td><td>Not Found</td><td>Resource not found</td></tr>
            <tr><td>500</td><td>Server Error</td><td>Internal server error</td></tr>
        </table>

        <h3>Error Response Format</h3>
<pre>
HTTP/1.1 401 Unauthorized

401 Unauthorized: API Key header missing
</pre>
    </section>

    <hr>

    <section id="signatures">
        <h2>Webhook Signature Verification</h2>

        <p>
            Each webhook delivery includes an HMAC-SHA256 signature.
            Receivers should verify this to ensure authenticity.
        </p>

        <h3>Headers Sent with Webhooks</h3>
        <table>
            <tr><th>Header</th><th>Description</th></tr>
            <tr>
                <td><code>X-Webhook-Signature</code></td>
                <td>HMAC-SHA256 signature (format: sha256=...)</td>
            </tr>
            <tr>
                <td><code>X-Webhook-Event</code></td>
                <td>Event type (e.g., "order.created")</td>
            </tr>
        </table>

        <h3>Verification Code (C#)</h3>
<pre>
public bool VerifySignature(string payload, string secret, string signature)
{
    using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(secret));
    var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(payload));
    var computed = $"sha256={Convert.ToHexString(hash).ToLower()}";
    return signature == computed;
}
</pre>

        <h3>Verification Code (JavaScript/Node.js)</h3>
<pre>
const crypto = require('crypto');

function verifySignature(payload, secret, signature) {
    const hmac = crypto.createHmac('sha256', secret);
    const computed = 'sha256=' + hmac.update(payload).digest('hex');
    return signature === computed;
}
</pre>

        <h3>Verification Code (Python)</h3>
<pre>
import hmac
import hashlib

def verify_signature(payload, secret, signature):
    computed = 'sha256=' + hmac.new(
        secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, computed)
</pre>
    </section>

    <hr>

    <footer>
        <p>
            <a href="index.html">← Back to Home</a> |
            <a href="https://github.com/abhinavsingh1311/webhooks-delivery-service">Source Code</a> |
            &copy; 2025 Abhinav Singh
        </p>
    </footer>

</body>
</html>