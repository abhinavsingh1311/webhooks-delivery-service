@page "/events"
@using Webhooks_System_Library.Entities
@rendermode InteractiveServer

<div class="container mt-4">
    <h2 class="mb-4">Webhook Events</h2>

    <!-- Error Alert -->
    @if (errors.Any())
    {
        <div class="alert alert-danger alert-dismissible">
            <ul class="mb-0">
                @foreach (var error in errors)
                {
                    <li>@error</li>
                }
            </ul>
        </div>
    }

    <!-- Filter Buttons -->
    <div class="card mb-4">
        <div class="card-body">
            <span class="me-2">Filter:</span>
            <div class="btn-group">
                <button class="btn mb-3 @(selectedFilter == null ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => FilterChanged(null)">
                    All
                </button>
                <button class="btn mb-3 @(selectedFilter == WebHookStatus.Pending ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => FilterChanged(WebHookStatus.Pending)">
                    Pending
                </button>
                <button class="btn mb-3 @(selectedFilter == WebHookStatus.Delivered ? "btn-success" : "btn-outline-success")"
                        @onclick="() => FilterChanged(WebHookStatus.Delivered)">
                    Delivered
                </button>
                <button class="btn mb-3 @(selectedFilter == WebHookStatus.Failed ? "btn-danger" : "btn-outline-danger")"
                        @onclick="() => FilterChanged(WebHookStatus.Failed)">
                    Failed
                </button>
                <button class="btn mb-3 @(selectedFilter == WebHookStatus.DeadLetter ? "btn-warning" : "btn-outline-warning")"
                        @onclick="() => FilterChanged(WebHookStatus.DeadLetter)">
                    Dead Letter
                </button>
            </div>
        </div>
    </div>

    <!-- Events Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Event History</h5>
        </div>
        <div class="card-body p-0">
            <div class="card-body mb-4">
                <select @onchange="OnEndpointFilterChanged">
                <option value="">All Endpoints</option>
                @foreach(var ep in endpoints)
                {
                    <option value="@ep.Id">@ep.Name</option> 
                }
                </select>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Event Type</th>
                            <th>Status</th>
                            <th>Attempts</th>
                            <th>Response</th>
                            <th>Created</th>
                            <th>Delivered</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ev in events)
                        {
                            <tr>
                                <td>@ev.Id</td>
                                <td><code>@ev.EventType</code></td>
                                <td>
                                    @switch (ev.Status)
                                    {
                                        case WebHookStatus.Pending:
                                            <span class="badge bg-primary">Pending</span>
                                            break;
                                        case WebHookStatus.Delivered:
                                            <span class="badge bg-success">Delivered</span>
                                            break;
                                        case WebHookStatus.Failed:
                                            <span class="badge bg-danger">Failed</span>
                                            break;
                                        case WebHookStatus.DeadLetter:
                                            <span class="badge bg-dark">Dead Letter</span>
                                            break;
                                    }
                                </td>
                                <td>@ev.AttemptCount / 6</td>
                                <td>
                                    @if (ev.LastResponsecode.HasValue)
                                    {
                                        <code>@ev.LastResponsecode</code>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>@ev.CreatedAt.ToString("MMM dd, HH:mm")</td>
                                <td>
                                    @if (ev.DeliveredAt.HasValue)
                                    {
                                        @ev.DeliveredAt.Value.ToString("MMM dd, HH:mm")
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (!events.Any())
            {
                <div class="text-center py-4 text-muted">
                    No events found
                </div>
            }
        </div>
    </div>

    <!-- Send Test Event -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Send Test Event</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Endpoint</label>
                    <select class="form-select" @bind="newEvent.EventPointId">
                        <option value="0">Select Endpoint</option>
                        @foreach (var ep in endpoints)
                        {
                            <option value="@ep.Id">@ep.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Event Type</label>
                    <input class="form-control" type="text" @bind="newEvent.EventType" placeholder="order.created" />
                </div>
                <div class="col-12">
                    <label class="form-label">Payload (JSON)</label>
                    <textarea class="form-control font-monospace" @bind="newEvent.Payload" rows="4" placeholder='{"key": "value"}'></textarea>
                </div>
            </div>
            <button type="button" class="btn btn-primary mt-3" @onclick="SubmitHandler">Send Event</button>
        </div>
    </div>
</div>